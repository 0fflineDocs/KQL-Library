{/* Section 5: Bottom Bar - Fixed */}
      <footer className="bg-gray-900 border-t border-gray-800 py-2.5 px-4">
        <div className="container mx-auto flex items-center justify-center">
          <div className="flex items-center gap-6">
            <a href="#" className="text-gray-400 hover:text-gray-300 p-2 rounded-full hover:bg-gray-800/50 transition-colors">
              <Github className="w-5 h-5" />
            </a>
            <a href="#" className="text-gray-400 hover:text-gray-300 p-2 rounded-full hover:bg-gray-800/50 transition-colors">
              <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M22 4.01C21.0174 4.5 19.9626 4.83162 18.865 5C19.9806 4.29938 20.8346 3.21812 21.234 1.96C20.1777 2.59133 19.0145 3.03343 17.805 3.27C16.8347 2.19418 15.4545 1.5 14.0023 1.5C11.1938 1.5 8.91576 3.77813 8.91576 6.58675C8.91576 7.0175 8.96326 7.43575 9.0575 7.83563C4.83679 7.6175 1.07954 5.60037 -0.0246059 2.36837C-0.498559 3.19225 -0.770809 4.15625 -0.770809 5.19025C-0.770809 7.14175 0.230441 8.85912 1.71319 9.85325C0.840309 9.83438 -0.000191125 9.58663 -0.000191125 9.22975V9.30138C-0.000191125 11.7595 1.75531 13.7919 4.11407 14.2968C3.25831 14.5348 2.3518 14.566 1.48082 14.3881C2.00266 16.389 3.86168 17.8432 6.06004 17.8894C4.3248 19.2248 2.14182 20.022 -0.226992 20.022C-0.681742 20.022 -1.12799 19.9976 -1.5683 19.9489C0.667258 21.3671 3.34382 22.1923 6.25756 22.1923C14.0055 22.1923 18.245 15.6573 18.245 9.98313C18.245 9.73475 18.2392 9.49062 18.2289 9.24825C19.2956 8.4545 20.2385 7.46512 21 6.33762L22 4.01Z" fill="currentColor"/>
              </svg>
            </a>
            <a href="#" className="text-gray-400 hover:text-gray-300 p-2 rounded-full hover:bg-gray-800/50 transition-colors">
              <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.477 2 2 6.477 2 12C2 17.523 6.477 22 12 22C17.523 22 22 17.523 22 12C22 6.477 17.523 2 12 2ZM12.5 16.6875C11.3333 16.6875 10.1771 16.6729 9.03125 16.6875C8.95 16.6896 8.86354 16.6458 8.79167 16.6042C7.66146 15.9167 6.52604 15.2344 5.39583 14.5521C5.32917 14.5125 5.3125 14.4625 5.3125 14.3979C5.31354 13.6896 5.31354 12.9812 5.31354 12.2708C5.31354 12.2396 5.33333 12.2083 5.34583 12.1375C5.42708 12.1792 5.50729 12.2188 5.58646 12.2646C6.43646 12.7833 7.28542 13.3042 8.13542 13.8229C8.96979 14.3292 9.80521 14.8354 10.6385 15.3438C10.7208 15.3938 10.7969 15.3979 10.8823 15.3458C11.6417 14.8667 12.4042 14.3896 13.1667 13.9125C14.0927 13.3375 15.0198 12.7604 15.9448 12.1854C15.9677 12.1708 15.9938 12.1583 16.0281 12.1354C16.0552 12.2063 16.0802 12.2604 16.0802 12.3146C16.0833 13.5438 16.0875 14.775 16.0792 16.0042C16.0781 16.1333 16.0292 16.2104 15.9417 16.2729C14.8229 17.0146 13.7031 17.7542 12.5833 18.4938C12.4906 18.5531 12.4177 18.55 12.325 18.4917C11.2104 17.7563 10.0958 17.0229 8.98125 16.2875C8.89479 16.2292 8.84062 16.1563 8.83958 16.05C8.83333 14.8146 8.83646 13.5812 8.83646 12.3458C8.83646 12.2708 8.83646 12.1937 8.83646 12.1021C8.86042 12.1167 8.87708 12.1271 8.89375 12.1375C9.93646 12.7979 10.9771 13.4604 12.0198 14.1208C12.3906 14.3542 12.7344 14.3563 13.1052 14.1229C14.1531 13.4563 15.2021 12.7917 16.2521 12.1292C16.3115 12.0917 16.3656 12.0854 16.4333 12.125C16.7 12.275 16.9729 12.4167 17.2427 12.5667C17.3104 12.6042 17.3292 12.6563 17.3292 12.7313C17.3292 13.4313 17.3271 14.1292 17.3302 14.8292C17.3302 14.9146 17.2948 14.9667 17.2323 15.0042C15.7667 15.9 14.3052 16.7979 12.8417 17.6958C12.7615 17.7448 12.6729 17.7417 12.5917 17.6917C11.0646 16.7594 9.53855 15.825 8.01042 14.8927C7.85312 14.7917 7.77396 14.6552 7.77396 14.4604C7.77708 12.3125 7.77604 10.1667 7.77396 8.01875C7.77396 7.85 7.84687 7.7375 7.98333 7.65417C9.60208 6.67292 11.2208 5.6875 12.8396 4.70417C12.9042 4.66458 12.9667 4.66562 13.0313 4.70521C14.6677 5.69896 16.3052 6.69271 17.9438 7.68333C18.0583 7.75625 18.1198 7.85417 18.1198 8C18.1198 10.1479 18.1156 12.2958 18.1229 14.4417C18.1229 14.6177 18.0531 14.7302 17.9125 14.8167C17.1125 15.3333 16.3135 15.8542 15.5135 16.3708C15.4531 16.4083 15.3781 16.4208 15.3167 16.3833C14.5313 15.8771 13.7448 15.3729 12.9604 14.8646C12.8958 14.825 12.8854 14.7896 12.8865 14.7188C12.8917 13.8521 12.8896 12.9854 12.8896 12.1208C12.8896 12.0875 12.8948 12.0542 12.9 12.0083C12.9542 12.0458 13.0063 12.0813 13.0563 12.1167C13.6844 12.5271 14.3115 12.9375 14.9396 13.3458C15.4979 13.7104 16.0573 14.0729 16.6156 14.4375C16.6594 14.4667 16.724 14.4813 16.7729 14.4833C16.8333 14.4875 16.8812 14.4354 16.8844 14.3771C16.8906 14.2896 16.8896 14.2 16.8906 14.1125C16.8906 12.0292 16.8948 9.94792 16.8885 7.86458C16.8885 7.73958 16.8302 7.66354 16.7344 7.60313C15.2375 6.675 13.7427 5.74271 12.2469 4.81458C12.0875 4.71354 11.9219 4.71458 11.7625 4.81771C10.2646 5.74583 8.76771 6.67292 7.27083 7.60521C7.17917 7.66458 7.12292 7.73646 7.12292 7.85729C7.12292 9.93229 7.11979 12.0052 7.125 14.0802C7.125 14.1698 7.15312 14.2271 7.22083 14.2698C8.83125 15.3083 10.4396 16.3521 12.05 17.3906C12.0885 17.4146 12.1458 17.4292 12.1385 17.4896C12.1385 17.5521 12.0875 17.5583 12.05 17.5813C12 17.6094 11.95 17.6375 11.9 17.6667C11.825 17.7125 11.7875 17.6938 11.7188 17.65C10.2229 16.7219 8.7271 15.7917 7.23021 14.8615C7.10104 14.7771 7.02812 14.6667 7.02812 14.5177C7.02396 12.15 7.02396 9.77917 7.02708 7.41146C7.02708 7.28021 7.0875 7.18646 7.19583 7.11667C8.99479 5.98646 10.7938 4.85625 12.5927 3.72708C12.65 3.68958 12.6927 3.68958 12.75 3.72708C14.55 4.85625 16.35 5.98542 18.1521 7.11354C18.259 7.18333 18.3177 7.2771 18.3177 7.40625C18.3219 9.77917 18.3219 12.15 18.3198 14.5208C18.3198 14.6573 18.2604 14.7573 18.1469 14.8302C16.3729 15.95 14.599 17.0708 12.825 18.1896C12.75 18.2375 12.6865 18.2542 12.599 18.2104C11.9104 17.7635 11.2198 17.3198 10.5292 16.8771C9.92188 16.4854 9.31563 16.0917 8.60833 15.6396C8.64583 15.6333 8.6625 15.6271 8.67917 15.6271C9.58958 15.6229 10.5 15.6146 11.4115 15.6208C11.5229 15.6208 11.6052 15.6771 11.6833 15.7271C12.4604 16.2219 13.2385 16.7146 14.0167 17.2073C14.1125 17.2698 14.2 17.2677 14.2958 17.2052C15.2073 16.6323 16.1177 16.0573 17.0292 15.4833C17.0833 15.45 17.1177 15.4135 17.1167 15.35C17.1167 14.7708 17.1167 14.1927 17.1177 13.6135C17.1177 13.6063 17.1135 13.6 17.099 13.5708C17.0667 13.5844 17.0375 13.5948 17.0115 13.6094C16.05 14.1917 15.0896 14.775 14.1281 15.3573C14.0583 15.4 14.0063 15.4083 13.9354 15.364C13.059 14.8271 12.1802 14.2927 11.3031 13.7563C11.2552 13.725 11.2292 13.6917 11.2313 13.6333C11.2365 13.1938 11.2343 12.7542 11.2333 12.3146C11.2333 12.2771 11.2333 12.2417 11.2333 12.1875C11.2812 12.2188 11.3208 12.2438 11.3594 12.2677C12.3844 12.8875 13.4094 13.5063 14.4344 14.1271C14.5458 14.1958 14.649 14.1938 14.7615 14.1229C15.7292 13.5292 16.7021 12.9396 17.6698 12.3469C17.7073 12.325 17.749 12.3156 17.8021 12.2979C17.8052 12.3542 17.8125 12.4042 17.8125 12.4542C17.8125 13.3583 17.8094 14.2635 17.8146 15.1677C17.8146 15.2917 17.7604 15.3594 17.6698 15.4177C15.9875 16.4583 14.3073 17.4979 12.625 18.5396C12.5646 18.5781 12.5094 18.5792 12.45 18.5417C10.7677 17.5 9.08438 16.4625 7.40312 15.4198C7.30208 15.3552 7.2479 15.2698 7.24896 15.15C7.25208 13.3708 7.25312 11.5917 7.24792 9.81354C7.24792 9.70313 7.29479 9.62917 7.37604 9.57708C7.70833 9.37083 8.04062 9.16458 8.37292 8.95833C8.45833 8.90625 8.5 8.90833 8.58542 8.96042C9.55312 9.56354 10.5229 10.1635 11.4917 10.7646C11.5552 10.8042 11.6031 10.8073 11.6667 10.7688C12.6552 10.1552 13.6448 9.54375 14.6354 8.93125C14.7063 8.8875 14.7229 8.84167 14.7229 8.76563C14.7208 8.06563 14.7219 7.36458 14.7219 6.66458C14.7219 6.64583 14.7177 6.62708 14.7146 6.60417C14.6823 6.625 14.6542 6.64167 14.6281 6.65833C12.9354 7.7 11.2427 8.74271 9.54896 9.78333C9.50208 9.8125 9.44583 9.83125 9.39167 9.83021C9.28125 9.82708 9.26562 9.73021 9.26562 9.64583C9.26562 9.44375 9.26042 9.24271 9.26562 9.04063C9.26667 8.98333 9.28229 8.94063 9.32604 8.91146C10.3583 8.23958 11.3885 7.56563 12.4198 6.89375C12.4792 6.85521 12.5292 6.85208 12.5896 6.88958C13.6031 7.50729 14.6188 8.12188 15.6344 8.73854C15.7021 8.77917 15.7333 8.82708 15.7333 8.90625C15.7323 9.25208 15.7344 9.59583 15.7323 9.9375C15.7323 10.0104 15.7021 10.0615 15.6437 10.0979C14.5344 10.7844 13.426 11.4729 12.3177 12.1604C12.2563 12.1979 12.2031 12.2 12.1417 12.1625C11.0323 11.475 9.92292 10.7865 8.81354 10.1C8.75208 10.0604 8.72188 10.0083 8.72188 9.9375C8.72396 9.59792 8.72188 9.25938 8.72188 8.92083C8.72188 8.86563 8.72188 8.8125 8.72188 8.74479C8.76667 8.77292 8.80417 8.79583 8.83958 8.81979C9.86562 9.44896 10.8906 10.0802 11.9167 10.7094C12.0167 10.7698 12.1 10.7698 12.2 10.7094C13.226 10.0802 14.251 9.45 15.2771 8.81979C15.3125 8.79583 15.35 8.77292 15.4021 8.74375C15.4052 8.8 15.4104 8.85 15.4104 8.9C15.4104 10.0115 15.4042 11.1208 15.4125 12.2302C15.4125 12.3583 15.3646 12.4396 15.2521 12.5104C14.3167 13.0958 13.3823 13.6813 12.4469 14.2656C12.3833 14.3042 12.3344 14.3052 12.2708 14.2667C11.3344 13.6813 10.4 13.0958 9.46458 12.5104C9.35208 12.4396 9.30312 12.3583 9.30417 12.2302C9.3125 11.1229 9.30625 10.0156 9.30521 8.90625C9.30521 8.86146 9.30833 8.81667 9.31042 8.75417C9.35208 8.78021 9.38542 8.8 9.41875 8.82083C10.45 9.45 11.4802 10.0802 12.5115 10.7094C12.625 10.7781 12.7198 10.7604 12.8271 10.6958C13.8615 10.0677 14.8979 9.44063 15.9333 8.81146C15.9958 8.77292 16.0375 8.7375 16.0375 8.64688C16.0333 7.90625 16.0375 7.16563 16.0354 6.42292C16.0354 6.35417 16.0115 6.3125 15.9604 6.28021C14.8344 5.58958 13.7094 4.89792 12.5833 4.20729C12.5125 4.16354 12.4604 4.16458 12.3896 4.20833C11.2656 4.89792 10.1406 5.58958 9.01458 6.27917C8.96042 6.31354 8.93333 6.35625 8.93333 6.42292C8.93229 7.16771 8.93542 7.9125 8.93125 8.65625C8.93125 8.74271 8.97083 8.77917 9.03958 8.82188C10.1677 9.51458 11.2938 10.2094 12.4219 10.9021C12.4979 10.9479 12.55 10.9479 12.625 10.9031C13.7521 10.2115 14.8792 9.51771 16.0073 8.82396C16.0719 8.7875 16.1073 8.75104 16.1073 8.66771C16.1042 8.61563 16.1375 8.5875 16.1948 8.58333C16.2906 8.57708 16.3854 8.58125 16.4813 8.58021C16.5531 8.57917 16.5958 8.61146 16.5927 8.68438C16.5875 8.76875 16.5896 8.85208 16.5896 8.93646C16.5896 9.32917 16.5865 9.72292 16.5896 10.1167C16.5896 10.1917 16.5625 10.2438 16.5021 10.2813C15.1771 11.1323 13.8542 11.9854 12.5313 12.8375C12.4979 12.8583 12.449 12.8667 12.4094 12.8427C12.349 12.8073 12.2844 12.7813 12.2146 12.7302C12.1667 12.6979 12.1219 12.6313 12.0333 12.6823C11.9479 12.7323 11.9771 12.8063 12.0167 12.8677C12.0594 12.9354 12.1219 12.9865 12.1823 13.0208C12.2219 13.0438 12.2719 13.0375 12.3177 13.0094C12.7948 12.7198 13.2719 12.4313 13.7469 12.1396C14.1646 11.8802 14.5833 11.6208 15 11.3625C15.0594 11.325 15.0865 11.2813 15.0854 11.2146C15.0813 10.3896 15.0833 9.56458 15.0833 8.73958C15.0833 8.70938 15.0833 8.67917 15.0833 8.63229C15.0677 8.64167 15.0563 8.64792 15.0458 8.65417C14.0188 9.28125 12.9927 9.90833 11.9656 10.5344C11.8813 10.5833 11.8094 10.5854 11.7271 10.5365C10.699 9.90938 9.67188 9.28125 8.6448 8.65417C8.63127 8.64636 8.71782 8.8648 8.64584 8.65417C8.64584 8.65417 8.63748 8.63125 8.63229 8.6125C8.63229 9.35521 8.62917 10.0979 8.63333 10.8406C8.63333 10.9167 8.65833 10.9667 8.71979 11.0042C9.96458 11.7896 11.2073 12.5781 12.45 13.3667C12.5177 13.4104 12.5677 13.4135 12.6375 13.3677C13.8844 12.5771 15.1323 11.7885 16.3823 10.9979C16.4313 10.9677 16.45 10.9354 16.45 10.8771C16.449 10.0469 16.45 9.21771 16.449 8.38958C16.449 8.35104 16.4365 8.32396 16.701 8.51979C17.6771 9.12708 17.6771 9.12708 17.6771 10.3135V15.15C17.6771 15.2375 17.6615 15.2844 17.5813 15.3344C15.875 16.3698 14.1708 17.4063 12.4646 18.4427C12.4104 18.4771 12.3573 18.4813 12.3031 18.4469C10.6 17.4115 8.89687 16.3771 7.19375 15.3417C7.11354 15.2917 7.09896 15.2448 7.09896 15.1573C7.10104 13.7188 7.09792 12.2792 7.10104 10.8406C7.10104 10.7458 7.06979 10.6844 6.99271 10.6365C6.83646 10.5396 6.68958 10.4292 6.53958 10.3313C6.47604 10.2896 6.46771 10.2438 6.46771 10.175C6.46979 9.41563 6.47083 8.65625 6.46667 7.89792C6.46667 7.80313 6.48958 7.74167 6.57708 7.69063C8.51354 6.45417 10.45 5.21771 12.3875 3.98125C12.4292 3.95521 12.4719 3.96146 12.5146 3.9875C14.4542 5.22604 16.3938 6.46458 18.3333 7.70313C18.4156 7.75417 18.4344 7.81354 18.4344 7.9C18.4333 10.0521 18.4323 12.2042 18.4354 14.3563C18.4354 14.4688 18.401 14.55 18.3125 14.6083C16.3875 15.8354 14.4635 17.0635 12.5396 18.2917C12.4917 18.3229 12.4469 18.325 12.3979 18.2948C10.4688 17.0646 8.53854 15.8344 6.60833 14.6052C6.52292 14.5479 6.49167 14.4698 6.49167 14.3698C6.49271 12.2094 6.49375 10.0469 6.49167 7.88646C6.49167 7.80417 6.50417 7.74688 6.57396 7.70208C7.05521 7.39688 7.53229 7.08542 8.01042 6.77604C8.0875 6.72813 8.12708 6.72396 8.20521 6.77188C9.62083 7.65 11.0375 8.525 12.4552 9.39896C12.5417 9.45417 12.5958 9.45312 12.6844 9.39688C14.099 8.52396 15.5146 7.65313 16.9302 6.78229C16.9698 6.75625 17.0177 6.74896 17.0885 6.79688C17.0885 6.8 17.0896 6.8 17.0896 6.80104C17.5312 7.08333 17.9729 7.36458 18.4146 7.64688C18.4844 7.68854 18.5042 7.74271 18.5042 7.82083C18.5031 9.99479 18.5031 12.1688 18.5031 14.3427C18.5031 14.4583 18.4604 14.5313 18.3656 14.5927C16.3615 15.8625 14.3604 17.1354 12.3573 18.4063C12.325 18.4271 12.2813 18.4438 12.25 18.4271C12.2031 18.4 12.1625 18.3604 12.1198 18.3344C10.225 17.1177 8.33229 15.9 6.4375 14.6844C6.31667 14.6042 6.2375 14.import React, { useState, useEffect, useRef } from 'react';
import { Github, List, Search, Mail, Clock, Users } from "lucide-react";

// Inline the cn utility function
const cn = (...classes: (string | undefined | null | false)[]) => {
  return classes.filter(Boolean).join(' ');
};

// Copy Button component
const CopyButton = ({ text, className = "" }) => {
  const [copied, setCopied] = useState(false);

  const handleCopy = async () => {
    try {
      await navigator.clipboard.writeText(text);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000); // Reset after 2 seconds
    } catch (err) {
      console.error('Failed to copy text: ', err);
    }
  };

  return (
    <button
      onClick={handleCopy}
      className={cn(
        "text-xs flex items-center gap-1 px-2 py-1 rounded-full transition-colors duration-300",
        "bg-gray-800 hover:bg-gray-700 focus:outline-none focus:ring-1 focus:ring-[#8be9fd]",
        copied ? "text-[#50fa7b]" : "text-[#8be9fd]",
        className
      )}
      style={{ minWidth: '68px', justifyContent: 'center' }}
    >
      {copied ? (
        <>
          <svg 
            className="w-3 h-3 animate-pulse" 
            fill="none" 
            stroke="currentColor" 
            viewBox="0 0 24 24" 
            xmlns="http://www.w3.org/2000/svg"
          >
            <path 
              strokeLinecap="round" 
              strokeLinejoin="round" 
              strokeWidth={2} 
              d="M5 13l4 4L19 7" 
            />
          </svg>
          <span>Copied!</span>
        </>
      ) : (
        <>
          <svg 
            className="w-3 h-3" 
            fill="none" 
            stroke="currentColor" 
            viewBox="0 0 24 24" 
            xmlns="http://www.w3.org/2000/svg"
          >
            <path 
              strokeLinecap="round" 
              strokeLinejoin="round" 
              strokeWidth={2} 
              d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" 
            />
          </svg>
          <span>Copy</span>
        </>
      )}
    </button>
  );
};

  // Expandable Search component
  const ExpandableSearch = () => {
    const [isExpanded, setIsExpanded] = useState(false);
    const searchInputRef = useRef<HTMLInputElement>(null);
    
    useEffect(() => {
      if (isExpanded && searchInputRef.current) {
        searchInputRef.current.focus();
      }
    }, [isExpanded]);
    
    return (
      <div className="relative flex items-center">
        {isExpanded ? (
          <div className="absolute right-0 flex items-center">
            <input
              ref={searchInputRef}
              type="text"
              placeholder="Search queries..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-48 bg-gray-800 border-none rounded-l px-3 py-1.5 text-sm text-white placeholder:text-gray-400 focus:outline-none"
              onBlur={() => {
                if (searchTerm.length === 0) {
                  setIsExpanded(false);
                }
              }}
            />
            <button 
              className="bg-gray-800 rounded-r p-1.5 text-gray-400 hover:text-gray-300"
              onClick={() => {
                setSearchTerm('');
                setIsExpanded(false);
              }}
            >
              <Search className="w-4 h-4" />
            </button>
          </div>
        ) : (
          <button
            className="text-gray-400 hover:text-gray-300 p-2 rounded-full hover:bg-gray-800/50"
            onClick={() => setIsExpanded(true)}
          >
            <Search className="w-5 h-5" />
          </button>
        )}
      </div>
    );
  };

// Inline component imports to avoid path issues
// Button component
const Button = ({ 
  variant = "default", 
  size = "default", 
  className = "", 
  children, 
  ...props 
}: any) => (
  <button
    className={cn(
      "inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors",
      "focus:outline-none focus:ring-1 focus:ring-[#8be9fd] focus:ring-offset-2 focus:ring-offset-gray-950",
      "disabled:opacity-50 disabled:pointer-events-none",
      className
    )}
    {...props}
  >
    {children}
  </button>
);

// Card components
const Card = ({ className = "", children, ...props }: any) => (
  <div
    className={cn("rounded-md border bg-card text-card-foreground shadow-sm", className)}
    {...props}
  >
    {children}
  </div>
);

interface Query {
  title: string;
  description: string;
  query: string;
  category: string;
  subCategory?: string;
  tags?: string[];
}

const KQLLibrary = () => {
  const [queries, setQueries] = useState<Query[]>([]);
  const [isLoading, setIsLoading] = useState<boolean>(true);
  const [loadingError, setLoadingError] = useState<string | null>(null);
  const [selectedCategory, setSelectedCategory] = useState<string | null>(null);
  const [selectedSubCategory, setSelectedSubCategory] = useState<string | null>(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  const [isSearchModalOpen, setIsSearchModalOpen] = useState(false);
  const contentRef = useRef<HTMLDivElement>(null);

  const categories = [
    "Entra ID", "Defender for Identity", "Defender for Endpoint",
    "Defender for Office 365", "Defender for Cloud Apps", "Sentinel", "Intune"
  ];

  const categoryInfo: any = {
    "Entra ID": {
      displayName: "Entra ID",
      textColor: "text-blue-400",
      buttonBg: "bg-gray-800 hover:bg-gray-700",
      subCategories: ["Conditional Access", "Passwordless", "Temporary Access Pass", "Guests"],
      fileName: "entraID.json"
    },
    "Defender for Identity": {
      displayName: "Defender for Identity",
      textColor: "text-yellow-400",
      buttonBg: "bg-gray-800 hover:bg-gray-700",
      subCategories: ["Service Accounts", "Dormant Accounts"],
      fileName: "defenderForIdentity.json"
    },
    "Defender for Endpoint": {
      displayName: "Defender for Endpoint",
      textColor: "text-green-400",
      buttonBg: "bg-gray-800 hover:bg-gray-700",
      subCategories: [],
      fileName: "defenderForEndpoint.json"
    },
    "Defender for Office 365": {
      displayName: "Defender for Office 365",
      textColor: "text-orange-400",
      buttonBg: "bg-gray-800 hover:bg-gray-700",
      subCategories: [],
      fileName: "defenderForOffice365.json"
    },
    "Defender for Cloud Apps": {
      displayName: "Defender for Cloud Apps",
      textColor: "text-purple-400", 
      buttonBg: "bg-gray-800 hover:bg-gray-700",
      subCategories: [],
      fileName: "defenderForCloudApps.json"
    },
    "Sentinel": {
      displayName: "Sentinel",
      textColor: "text-red-400",
      buttonBg: "bg-gray-800 hover:bg-gray-700",
      subCategories: ["Hunting", "Automation"],
      fileName: "sentinel.json"
    },
    "Intune": {
      displayName: "Intune",
      textColor: "text-cyan-400",
      buttonBg: "bg-gray-800 hover:bg-gray-700",
      subCategories: [],
      fileName: "intune.json"
    }
  };

  useEffect(() => {
    const fetchAllQueries = async () => {
      setIsLoading(true);
      setLoadingError(null);
      
      try {
        const allQueries: Query[] = [];
        const fetchPromises = categories.map(async (category) => {
          const fileName = categoryInfo[category]?.fileName || `${category.toLowerCase().replace(/\s+/g, '')}.json`;
          try {
            const response = await fetch(`/queries/${fileName}`);
            if (!response.ok) {
              console.warn(`Failed to fetch queries for ${category}: ${response.status}`);
              return [];
            }
            const data: Query[] = await response.json();
            return data;
          } catch (error) {
            console.warn(`Error fetching ${category} queries:`, error);
            return [];
          }
        });

        // Wait for all fetch requests to complete
        const results = await Promise.all(fetchPromises);
        
        // Combine all results into a single array
        results.forEach(categoryQueries => {
          if (Array.isArray(categoryQueries)) {
            allQueries.push(...categoryQueries);
          }
        });
        
        setQueries(allQueries);
      } catch (error) {
        console.error("Error fetching queries:", error);
        setLoadingError("Failed to load queries. Please try again later.");
        setQueries([]);
      } finally {
        setIsLoading(false);
      }
    };
    
    fetchAllQueries();
  }, []);

  const filteredQueries = queries.filter(query => {
    const searchMatch =
      query.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
      query.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
      (query.tags?.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase())));
    const categoryMatch = !selectedCategory || query.category === selectedCategory;
    const subCategoryMatch = !selectedSubCategory || query.subCategory === selectedSubCategory;
    return searchMatch && categoryMatch && subCategoryMatch;
  });

  // Function to determine card height based on query length
  const getCardContentHeight = (queryText: string) => {
    const lineCount = (queryText.match(/\n/g) || []).length + 1;
    if (lineCount <= 1) return 'min-h-[40px]';
    if (lineCount <= 3) return 'min-h-[80px]';
    if (lineCount <= 5) return 'min-h-[120px]';
    return 'min-h-[180px] max-h-[280px]';
  };

  return (
    <div className="flex flex-col h-screen bg-gray-950 text-gray-100 overflow-hidden">
      {/* Section 1: Header - Fixed */}
      <header className="bg-gray-900 border-b border-gray-800 py-4 px-4">
        <div className="container mx-auto flex items-center justify-between">
          <h1 className="text-2xl font-bold bg-gradient-to-r from-orange-400 to-orange-600 text-transparent bg-clip-text">
            KQL Library
          </h1>
          <div className="flex items-center gap-2">
            <ExpandableSearch />
          </div>
        </div>
      </header>

      {/* Section 2: Categories - Fixed */}
      <div className="bg-gray-900/95 border-b border-gray-800 py-4">
        <div className="container mx-auto px-4">
          <div className="flex flex-wrap justify-center gap-2">
            {categories.map((category) => (
              <Button
                key={category}
                className={cn(
                  "px-3 py-2 rounded-md font-medium",
                  categoryInfo[category]?.buttonBg,
                  selectedCategory === category
                    ? "bg-gray-700 ring-1 ring-[#8be9fd]"
                    : ""
                )}
                onClick={() => {
                  setSelectedCategory(prev => prev === category ? null : category);
                  setSelectedSubCategory(null);
                }}
              >
                <span className="text-[#bd93f9]">
                  {categoryInfo[category]?.displayName || category}
                </span>
              </Button>
            ))}
          </div>
        </div>
      </div>

      {/* Section 3: Subcategories - Fixed (only visible when a category is selected) */}
      {selectedCategory && categoryInfo[selectedCategory]?.subCategories?.length > 0 && (
        <div className="bg-gray-900/90 border-b border-gray-800 py-3">
          <div className="container mx-auto px-4">
            <div className="flex flex-wrap justify-center gap-2">
              {categoryInfo[selectedCategory].subCategories.map((subCategory: string) => (
                <Button
                  key={subCategory}
                  className={cn(
                    "px-3 py-2 rounded-md bg-gray-800 hover:bg-gray-700",
                    selectedSubCategory === subCategory
                      ? "bg-gray-700 ring-1 ring-[#8be9fd]"
                      : ""
                  )}
                  onClick={() => setSelectedSubCategory(prev => prev === subCategory ? null : subCategory)}
                >
                  <span className="text-[#ff79c6]">{subCategory}</span>
                </Button>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* Section 4: Query Cards - Scrollable Content */}
      <div 
        className="flex-1 overflow-y-auto p-4 bg-gray-950" 
        ref={contentRef}
      >
        <div className="container mx-auto">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {isLoading ? (
              <div className="col-span-full text-center text-gray-400 py-8">
                Loading queries...
              </div>
            ) : loadingError ? (
              <div className="col-span-full text-center text-red-400 py-8">
                {loadingError}
              </div>
            ) : filteredQueries.length === 0 ? (
              <div className="col-span-full text-center text-gray-400 py-8">
                No queries found matching your search.
              </div>
            ) : (
              filteredQueries.map((query, index) => (
                <Card 
                key={index} 
                className="border-gray-800 hover:shadow-lg hover:shadow-blue-900/20 transition-all duration-300 bg-[#1e1e2e] flex flex-col transform hover:-translate-y-1 overflow-hidden"
              >
                <div className="bg-gray-800 py-3 px-4 flex justify-between items-center">
                  <div>
                    <h3 className="text-base font-semibold text-[#50fa7b]">
                      {query.title}
                    </h3>
                    <p className="text-xs text-[#ffb86c]">
                      {query.description}
                    </p>
                  </div>
                  <CopyButton text={query.query} />
                </div>
                <div className="flex-1 p-0">
                  <div className={`w-full bg-[#1e1e2e] overflow-auto ${getCardContentHeight(query.query)}`}>
                    <pre className="p-3 text-xs text-gray-200 whitespace-pre-wrap break-words h-full">
                      <code>{query.query}</code>
                    </pre>
                  </div>
                </div>
              </Card>
              ))
            )}
          </div>
        </div>
      </div>

      {/* Section 5: Bottom Bar - Fixed */}
      <footer className="bg-gray-900 border-t border-gray-800 py-2.5 px-4">
        <div className="container mx-auto flex items-center justify-center">
          <div className="flex items-center gap-6">
            <a href="#" className="text-gray-400 hover:text-gray-300 p-2 rounded-full hover:bg-gray-800/50 transition-colors">
              <Github className="w-5 h-5" />
            </a>
            <a href="#" className="text-gray-400 hover:text-gray-300 p-2 rounded-full hover:bg-gray-800/50 transition-colors">
              <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M22 4.01C21.0174 4.5 19.9626 4.83162 18.865 5C19.9806 4.29938 20.8346 3.21812 21.234 1.96C20.1777 2.59133 19.0145 3.03343 17.805 3.27C16.8347 2.19418 15.4545 1.5 14.0023 1.5C11.1938 1.5 8.91576 3.77813 8.91576 6.58675C8.91576 7.0175 8.96326 7.43575 9.0575 7.83563C4.83679 7.6175 1.07954 5.60037 -0.0246059 2.36837C-0.498559 3.19225 -0.770809 4.15625 -0.770809 5.19025C-0.770809 7.14175 0.230441 8.85912 1.71319 9.85325C0.840309 9.83438 -0.000191125 9.58663 -0.000191125 9.22975V9.30138C-0.000191125 11.7595 1.75531 13.7919 4.11407 14.2968C3.25831 14.5348 2.3518 14.566 1.48082 14.3881C2.00266 16.389 3.86168 17.8432 6.06004 17.8894C4.3248 19.2248 2.14182 20.022 -0.226992 20.022C-0.681742 20.022 -1.12799 19.9976 -1.5683 19.9489C0.667258 21.3671 3.34382 22.1923 6.25756 22.1923C14.0055 22.1923 18.245 15.6573 18.245 9.98313C18.245 9.73475 18.2392 9.49062 18.2289 9.24825C19.2956 8.4545 20.2385 7.46512 21 6.33762L22 4.01Z" fill="currentColor"/>
              </svg>
            </a>
            <a href="#" className="text-gray-400 hover:text-gray-300 p-2 rounded-full hover:bg-gray-800/50 transition-colors">
              <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.477 2 2 6.477 2 12C2 17.523 6.477 22 12 22C17.523 22 22 17.523 22 12C22 6.477 17.523 2 12 2ZM12.5 16.4C11.25 16.4 10.1 16.25 9 16C8.8 15.95 8.6 15.9 8.4 15.8C7.1 14.9 6 15.7 5.7 14.9C5.6 14.6 5.5 14.5 5.5 14.2C5.5 13.9 5.6 13.7 5.7 13.5C5.8 13.4 5.9 13.3 6 13.3C7.7 13.9 9.4 14.3 11.3 14.3C12.5 14.3 15.1 14.1 15.7 13.3C15.9 13.1 16 12.9 16 12.7C16 12.3 15.6 12 15.2 11.9C14.8 11.8 14.4 11.6 13.9 11.5C13.4 11.4 11.5 11.2 11.3 11.2C10.7 11.1 10 10.8 9.3 10.5C8.7 10.2 8.2 10 7.8 9.8C7.1 9.5 6.5 9.1 6.1 8.7C5.7 8.2 5.5 7.7 5.5 7C5.5 6.1 6 5.3 6.9 4.8C8.2 4 9.7 3.8 11.3 3.8C12.3 3.8 13.2 3.9 14.2 4.1C14.5 4.2 14.8 4.2 15.2 4.3C15.5 4.4 15.8 4.5 16.1 4.6C16.6 4.8 16.8 5.3 16.7 5.8C16.6 6.3 16.3 6.5 15.8 6.5C15.5 6.5 15.2 6.3 14.9 6.2C14.1 5.9 13.3 5.7 12.5 5.7C11.6 5.7 10.7 5.8 9.9 6.1C9.2 6.4 8.9 6.9 8.9 7.5C8.9 7.8 9 8.1 9.2 8.3C9.4 8.5 9.7 8.7 10 8.8C10.4 9 10.8 9.1 11.3 9.2C11.9 9.3 12.5 9.4 13.1 9.5C13.9 9.6 14.6 9.8 15.2 10.1C15.9 10.4 16.5 10.7 16.9 11.2C17.3 11.7 17.5 12.3 17.5 13C17.5 13.8 17.1 14.5 16.4 15.1C15.4 16 14 16.4 12.5 16.4Z" fill="currentColor"/>
              </svg>
            </a>
            <a href="#" className="text-gray-400 hover:text-gray-300 p-2 rounded-full hover:bg-gray-800/50 transition-colors">
              <Mail className="w-5 h-5" />
            </a>
          </div>
        </div>
      </footer>

      {/* Search Modal */}
      {/* <SearchModal 
        isOpen={isSearchModalOpen} 
        onClose={() => setIsSearchModalOpen(false)}
        onSearch={() => {}}
        searchTerm={searchTerm}
        setSearchTerm={setSearchTerm}
      /> */}
    </div>
  );
};

export default KQLLibrary;
